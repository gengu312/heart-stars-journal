# CLAUDE.md

此文件为 Claude Code (claude.ai/code) 提供本仓库的开发指南。

## 项目概述

Veil Social 是基于 Lens Protocol 的 Web3 去中心化社交媒体平台。采用 pnpm workspaces 管理的 monorepo，包含 React 前端、Hono 后端和 XMTP 私信系统。

## 基本原则

- 严格遵循用户的需求
- 逐步规划解决方案，确认后再编写代码
- 编写正确、无错误、完整的代码
- 优先考虑清晰性和可读性
- 不留 TODO、占位符或未完成的部分
- 如果不确定，坦诚说明，不要猜测
- 始终使用简体中文回复

## 常用命令

```bash
# 开发
pnpm dev              # 启动所有服务（web 端口 4783，api）
pnpm build            # 构建所有包
pnpm typecheck        # TypeScript 类型检查

# 代码检查 (Biome)
pnpm biome:check      # 检查代码风格
pnpm biome:fix        # 自动修复代码风格问题

# 移动端 (Capacitor) - 在 apps/web/ 目录下运行
pnpm build:mobile     # 构建 + 生成资源 + 同步
npx cap open ios      # 在 Xcode 中打开 iOS 项目
npx cap open android  # 在 Android Studio 中打开 Android 项目
npx cap sync          # 同步 web 构建到原生项目

# 维护脚本
node script/clean.mjs                 # 清理 node_modules 和缓存
node script/update-dependencies.mjs   # 更新依赖
```

## 技术栈

### 前端
- ReactJS + Vite + TypeScript
- TailwindCSS + shadcn/ui + Radix + HeadlessUI
- Apollo GraphQL + Zustand + TanStack React Query
- Zod + Prosekit + react-i18next
- Remark + Rehype（Markdown 处理）
- Capacitor (iOS / Android)

### 后端
- Hono（轻量级 Web 框架）
- PostgreSQL（数据库）
- 4EVERLAND（去中心化存储）

## 架构

### Monorepo 结构
```
apps/
├── api/           # Hono 后端（tsx watch，PostgreSQL，4EVERLAND 存储）
└── web/           # React + Vite 前端

packages/
├── config/        # 共享配置 (@hey/config)
├── data/          # 常量和数据 (@hey/data)
├── helpers/       # 工具函数 (@hey/helpers)
├── indexer/       # Lens Protocol GraphQL 索引 (@hey/indexer)
└── types/         # TypeScript 类型 (@hey/types)
```

### 状态管理
- **Zustand stores** 位于 `apps/web/src/store/`
  - `persisted/` - LocalStorage 持久化（useAccountStore, useAuthStore）
  - `non-persisted/` - 会话级别（useXmtpStore, modal stores, alert stores）
- **Apollo Client** 用于 GraphQL（Lens Protocol 查询）
- **TanStack React Query** 用于异步状态
- 最小化 `useEffect` 和 `setState`，优先使用派生状态

### XMTP 私信系统
- `XmtpContext.tsx` - 管理 XMTP V3 browser-sdk 客户端生命周期的 Provider
- `useXmtpStore.ts` - 连接状态、同步状态、客户端状态
- `helpers/xmtp*.ts` - 同步工具、时间格式化、IndexedDB 映射
- `components/Messages/` - 对话列表、聊天、群组管理组件
- **SyncStatus** 的 `isBlocking` 和 `source` 字段控制全局加载遮罩行为

### 关键模式
- 平台检测：`@/helpers/platform`（`isNative`, `isIOS`, `isAndroid`, `isWeb`）
- 钱包检测：`@/helpers/walletDetection`（`isWalletBrowser()`）

## 代码规范

### 命名规范
- 变量和函数：camelCase（如 `handleClick`、`isLoading`）
- 事件处理器：`handle` 前缀（如 `handleSubmit`）
- 布尔变量：动词前缀（如 `isLoading`、`hasError`、`canDelete`）
- 环境变量：大写（如 `LENS_NETWORK`）

### React 规范
- 使用函数式组件 + TypeScript interfaces
- Props 接口以组件名命名（如 `AccountProps`）
- 组件在文件末尾 `export default`
- 仅使用 Tailwind 类样式化，不用 CSS 或 style 标签
- 优先使用箭头函数
- 尽可能使用早返回提高可读性

### TypeScript 和 Zod 规范
- 整个代码库使用 TypeScript，对象形状优先使用 interface
- 使用 Zod 进行模式验证和类型推断
- 避免使用 enum，优先使用字面量类型或 map

### 错误处理和验证
- 首先处理错误和边界情况
- 对错误条件使用早返回以避免嵌套
- 应用守卫子句尽早管理无效状态
- 提供清晰的错误日志和用户友好的消息

## 国际化 (i18n)

**所有用户可见的文本必须使用 i18n，禁止硬编码！**

```tsx
// ❌ 错误
<button>Login</button>

// ✅ 正确
const { t } = useTranslation("auth");
<button>{t("login")}</button>
```

### 命名空间
- `auth` - 认证（登录、注册、钱包连接）
- `navbar` - 导航栏
- `post` - 帖子
- `common` - 通用 UI 元素
- `profile` - 个人资料
- `messages` - XMTP 私信/群聊
- `groups` - Lens Protocol 社区
- `settings` / `notification` / `bookmarks` / `explore` / `home`

### 翻译文件位置
- 中文：`apps/web/src/locales/zh-CN/[namespace].json`
- 英文：`apps/web/src/locales/en/[namespace].json`

### 特殊场景处理

**动态文本中的链接或格式化**（使用 Trans 组件）：
```tsx
import { Trans } from "react-i18next";

// 翻译文件: "agreement": "连接钱包即表示你同意我们的 <link>条款</link>。"
<Trans
  i18nKey="agreement"
  ns="auth"
  components={{ link: <Link to="/terms" /> }}
/>
```

**带参数的翻译**：
```tsx
// 翻译文件: "welcome": "欢迎，{{name}}！"
{t("welcome", { name: userName })}
```

### 重要：代码命名 vs 用户文本

**代码层面的命名和用户可见文本是分离的！**

- **代码保持 `group`/`Group`**（因为 Lens Protocol GraphQL schema 使用 `Group` 类型）
- **用户看到的是翻译后的文本**（中文显示"社区"，英文显示"Communities"）

```tsx
// ✅ 正确：代码用 group，显示用翻译
const Groups = () => {
  const { t } = useTranslation("groups");
  const group = data.group;  // 代码层面保持 group
  return <div>{t("groups")}</div>;  // 用户看到"社区"
};
```

## 移动端开发 (Capacitor)

### 平台检测
```tsx
import { isNative, isIOS, isAndroid, isWeb } from "@/helpers/platform";

if (isNative) {
  // 原生平台特定代码
}
```

### 关键要点
- 优先 Web 和移动端共享代码
- 使用 Capacitor 插件时先检测平台
- 修改 Web 代码后运行 `pnpm build && npx cap sync`
- XMTP Browser SDK 在 Capacitor WebView 中可直接使用

### Capacitor 插件使用
```tsx
import { Capacitor } from "@capacitor/core";

const pickImage = async () => {
  if (Capacitor.isNativePlatform()) {
    try {
      // 原生功能
    } catch (error) {
      // 降级到 Web 方案
    }
  }
  // Web fallback
};
```

## MetaMask 内置浏览器

钱包浏览器需要特殊处理：
- 页面加载时清理 wagmi/walletconnect 的 localStorage
- 强制使用 `injected` connector 类型
- 必须在 MetaMask 移动端真机测试，桌面浏览器测试不够

## Git 提交规则

- commit message 使用简体中文
- 格式：`类型: 简短但清晰的描述`
- 类型：`feat` / `fix` / `docs` / `style` / `refactor` / `test` / `chore`
- 示例：
  - `feat: 添加用户登录功能`
  - `fix: 修复群组消息发送失败问题`
  - `feat: 基地管理完整功能（增删改查、图片上传、状态切换）`

## 文档规范

### 何时创建文档

**⚠️ 小 bug 修复不需要写文档，只有重大变更才需要！**

**需要创建文档**：
- 新增重大功能模块
- 重要的配置变更
- 架构变更或大规模重构
- 用户明确要求

**不需要创建文档**：
- 小的 bug 修复、UI 调整、代码优化
- 依赖更新、文案修改、翻译更新

### 文档存放规范
- 文件名使用中文（如 `快速部署指南.md`）
- 统一存放在 `docs/` 目录，按类型分类：
  - 部署相关 → `docs/部署指南/`
  - 配置相关 → `docs/配置指南/`
  - 开发相关 → `docs/开发指南/`
  - 功能文档 → `docs/功能模块/[功能名]/`
  - XMTP相关 → `docs/XMTP私信/`
- 技术名词保留英文（WalletConnect、XMTP、Vite）

## 文件操作规则

- 删除文件前必须先征得用户同意
- 对于重要配置文件，永远不要建议删除
- 大规模重构前需要先讨论方案

## 环境变量

**API** (`apps/api/.env`)：
- `LENS_NETWORK` – Lens 网络（`mainnet` / `testnet`）
- `LENS_DATABASE_URL` – PostgreSQL 连接
- `PRIVATE_KEY` – 签名私钥
- `EVER_ACCESS_KEY` / `EVER_ACCESS_SECRET` – 4EVERLAND 存储密钥

**Web** (`apps/web/.env`)：
- `LENS_NETWORK` – Lens 网络

## 参考资料

- [Lens Protocol Docs](https://lens.xyz/docs/protocol)
- [Grove Storage Docs](https://lens.xyz/docs/storage)
- [Capacitor Docs](https://capacitorjs.com/docs)
