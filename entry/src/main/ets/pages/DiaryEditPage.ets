
import router from '@ohos.router';
import { CommonConstants } from '../common/constants/CommonConstants';
import { ThemeColors, StyleConstants } from '../common/constants/ThemeConstants';
import { GlassCard } from '../components/GlassCard';
import { DiaryEntry } from '../model/DiaryEntry';
import { DatabaseManager } from '../service/DatabaseManager';
import { StardustService } from '../service/StardustService';
import { Logger } from '../common/utils/Logger';
import promptAction from '@ohos.promptAction';
import picker from '@ohos.file.picker';

@Entry
@Component
struct DiaryEditPage {
  @StorageLink('isDarkMode') isDarkMode: boolean = true;
  @State content: string = '';
  @State mood: string = 'ðŸ˜';
  @State intensity: number = 3;
  @State selectedImage: string = '';
  
  // ç®€å•çš„å¿ƒæƒ…åˆ—è¡¨
  private moodOptions: string[] = ['ðŸ˜„', 'ðŸ˜Œ', 'ðŸ˜', 'ðŸ˜£', 'ðŸ˜ ', 'ðŸ˜¢', 'ðŸ¤©'];

  async saveDiary() {
    if (this.content.trim() === '') {
      // å®žé™…åº”ç”¨ä¸­åº”ç”¨å¼¹çª—æç¤º
      return;
    }
    
    // æž„é€ æ—¥è®°å¯¹è±¡
    const newDiary = new DiaryEntry(
      this.content,
      this.mood,
      this.intensity,
      [], // tags
      this.selectedImage ? [this.selectedImage] : [] // images
    );
    
    try {
      await DatabaseManager.getInstance().insertDiary(newDiary);
      Logger.info('Diary saved successfully');
      
      // å¢žåŠ ç§¯åˆ†
      const newTotal = await StardustService.getInstance().addStardust(StardustService.EARN_DIARY, 'Writing Diary');
      
      promptAction.showToast({
        message: `âœ¨ èŽ·å¾— ${StardustService.EARN_DIARY} æ˜Ÿè¾°ï¼å½“å‰: ${newTotal}`,
        duration: 2000
      });

      router.back();
    } catch (err) {
      Logger.error(`Failed to save diary: ${JSON.stringify(err)}`);
    }
  }

  async selectImage() {
    try {
      const photoSelectOptions = new picker.PhotoSelectOptions();
      photoSelectOptions.MIMEType = picker.PhotoViewMIMETypes.IMAGE_TYPE;
      photoSelectOptions.maxSelectNumber = 1;
      const photoPicker = new picker.PhotoViewPicker();
      const photoSelectResult = await photoPicker.select(photoSelectOptions);
      if (photoSelectResult && photoSelectResult.photoUris.length > 0) {
        this.selectedImage = photoSelectResult.photoUris[0];
      }
    } catch (err) {
      Logger.error(`PhotoPicker failed: ${JSON.stringify(err)}`);
    }
  }

  build() {
    Stack() {
      // èƒŒæ™¯
      Column()
        .width('100%')
        .height('100%')
        .backgroundColor(this.isDarkMode ? ThemeColors.Dark.Bg : ThemeColors.Light.Bg)

      // å†…å®¹åŒºåŸŸ
      Column() {
        // é¡¶éƒ¨å¯¼èˆªæ 
        Row() {
          Text('å–æ¶ˆ')
            .fontColor(this.isDarkMode ? ThemeColors.Dark.TextSecondary : ThemeColors.Light.TextSecondary)
            .onClick(() => {
              router.back();
            })
          
          Text('æ–°æ—¥è®°')
            .fontSize(StyleConstants.FONT_LG)
            .fontWeight(FontWeight.Bold)
            .fontColor(this.isDarkMode ? ThemeColors.Dark.TextPrimary : ThemeColors.Light.TextPrimary)
          
          Text('ä¿å­˜')
            .fontColor(this.isDarkMode ? ThemeColors.Dark.Accent : ThemeColors.Light.Accent)
            .fontWeight(FontWeight.Bold)
            .onClick(() => {
              this.saveDiary();
            })
        }
        .width('100%')
        .justifyContent(FlexAlign.SpaceBetween)
        .padding(StyleConstants.SPACE_MD)

        Scroll() {
          Column({ space: StyleConstants.SPACE_MD }) {
            
            // å¿ƒæƒ…é€‰æ‹©
            GlassCard({ customPadding: StyleConstants.SPACE_MD }) {
              Column({ space: StyleConstants.SPACE_SM }) {
                Text('æ­¤åˆ»å¿ƒæƒ…')
                  .fontSize(StyleConstants.FONT_MD)
                  .fontColor(this.isDarkMode ? ThemeColors.Dark.TextSecondary : ThemeColors.Light.TextSecondary)
                  .width('100%')
                
                // Emoji åˆ—è¡¨
                List({ space: StyleConstants.SPACE_SM }) {
                  ForEach(this.moodOptions, (item: string) => {
                    ListItem() {
                      Text(item)
                        .fontSize(32)
                        .padding(8)
                        .backgroundColor(this.mood === item ? 
                          (this.isDarkMode ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.05)') : 
                          Color.Transparent)
                        .borderRadius(8)
                        .onClick(() => {
                          this.mood = item;
                        })
                    }
                  })
                }
                .listDirection(Axis.Horizontal)
                .width('100%')
                .scrollBar(BarState.Off)

                // å¼ºåº¦æ»‘å—
                Row() {
                  Text('å¼ºåº¦')
                    .fontColor(this.isDarkMode ? ThemeColors.Dark.TextSecondary : ThemeColors.Light.TextSecondary)
                  Slider({
                    value: this.intensity,
                    min: 1,
                    max: 5,
                    style: SliderStyle.OutSet
                  })
                    .trackColor(this.isDarkMode ? '#334155' : '#E2E8F0')
                    .selectedColor(this.isDarkMode ? ThemeColors.Dark.Accent : ThemeColors.Light.Accent)
                    .onChange((value: number) => {
                      this.intensity = value;
                    })
                    .layoutWeight(1)
                }
                .width('100%')
                .margin({ top: 8 })
              }
            }

            // æ–‡æœ¬è¾“å…¥
            GlassCard({ customPadding: StyleConstants.SPACE_MD }) {
               TextArea({ placeholder: 'å†™ä¸‹æ­¤åˆ»çš„æƒ³æ³•...', text: this.content })
                .placeholderColor(this.isDarkMode ? 'rgba(255,255,255,0.3)' : 'rgba(0,0,0,0.3)')
                .fontColor(this.isDarkMode ? ThemeColors.Dark.TextPrimary : ThemeColors.Light.TextPrimary)
                .backgroundColor(Color.Transparent)
                .height(300)
                .onChange((value: string) => {
                  this.content = value;
                })
            }

            // å›¾ç‰‡é€‰æ‹©é¢„è§ˆ
            GlassCard({ customPadding: StyleConstants.SPACE_MD }) {
              Column({ space: StyleConstants.SPACE_SM }) {
                Text('å›¾ç‰‡è®°å½• (å¯é€‰)')
                  .fontSize(StyleConstants.FONT_MD)
                  .fontColor(this.isDarkMode ? ThemeColors.Dark.TextSecondary : ThemeColors.Light.TextSecondary)
                  .width('100%')

                if (this.selectedImage) {
                  Stack({ alignContent: Alignment.TopEnd }) {
                    Image(this.selectedImage)
                      .width('100%')
                      .height(200)
                      .borderRadius(8)
                      .objectFit(ImageFit.Cover)
                    
                    Button({ type: ButtonType.Circle }) {
                      Text('Ã—').fontColor('#FFFFFF').fontSize(16)
                    }
                    .width(24)
                    .height(24)
                    .backgroundColor('rgba(0,0,0,0.5)')
                    .margin(8)
                    .onClick(() => {
                      this.selectedImage = '';
                    })
                  }
                } else {
                  Button() {
                    Row() {
                      Text('+ æ·»åŠ å›¾ç‰‡')
                        .fontColor(this.isDarkMode ? ThemeColors.Dark.TextPrimary : ThemeColors.Light.TextPrimary)
                    }
                  }
                  .width('100%')
                  .height(100)
                  .backgroundColor(this.isDarkMode ? 'rgba(255,255,255,0.05)' : 'rgba(0,0,0,0.05)')
                  .borderRadius(8)
                  .borderStyle(BorderStyle.Dashed)
                  .borderWidth(1)
                  .borderColor(this.isDarkMode ? 'rgba(255,255,255,0.2)' : 'rgba(0,0,0,0.1)')
                  .onClick(() => {
                    this.selectImage();
                  })
                }
              }
            }
          }
          .padding(StyleConstants.SPACE_MD)
        }
      }
      .width('100%')
      .height('100%')
    }
  }
}
