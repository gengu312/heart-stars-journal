
import router from '@ohos.router';
import common from '@ohos.app.ability.common';
import { CommonConstants } from '../common/constants/CommonConstants';
import { ThemeColors, StyleConstants } from '../common/constants/ThemeConstants';
import { GlassCard } from '../components/GlassCard';
import { BackupService } from '../service/BackupService';
import { Logger } from '../common/utils/Logger';
import promptAction from '@ohos.promptAction';

@Entry
@Component
struct SettingsPage {
  @StorageLink('isDarkMode') isDarkMode: boolean = true;

  aboutToAppear() {
    const context = getContext(this) as common.UIAbilityContext;
    BackupService.getInstance().init(context);
  }

  async handleExport() {
    const path = await BackupService.getInstance().exportToFile();
    if (path) {
      promptAction.showDialog({
        title: 'å¯¼å‡ºæˆåŠŸ',
        message: `æ–‡ä»¶å·²ä¿å­˜è‡³:\n${path}`,
        buttons: [{ text: 'ç¡®å®š', color: this.isDarkMode ? ThemeColors.Dark.Accent : ThemeColors.Light.Accent }]
      });
    } else {
      promptAction.showToast({ message: 'å¯¼å‡ºå¤±è´¥' });
    }
  }

  // æ¨¡æ‹Ÿå¯¼å…¥åŠŸèƒ½ (å› æ— æ³•ç®€å•è®¿é—®æ–‡ä»¶é€‰æ‹©å™¨ï¼Œè¿™é‡Œæä¾›ä¸€ä¸ªè¾“å…¥æ¡†ç”¨äºæµ‹è¯•)
  async handleImport() {
    // å®é™…é¡¹ç›®ä¸­åº”è°ƒç”¨ Pickerï¼Œè¿™é‡Œç®€åŒ–ä¸ºæç¤º
    promptAction.showDialog({
      title: 'å¯¼å…¥åŠŸèƒ½',
      message: 'ç”±äºç³»ç»Ÿé™åˆ¶ï¼Œæ¼”ç¤ºç‰ˆæš‚åªæ”¯æŒé€šè¿‡ä»£ç æˆ–è°ƒè¯•å·¥å…·æ³¨å…¥ JSON å­—ç¬¦ä¸²è¿›è¡Œæ¢å¤ã€‚',
      buttons: [{ text: 'æˆ‘çŸ¥é“äº†', color: this.isDarkMode ? ThemeColors.Dark.Accent : ThemeColors.Light.Accent }]
    });
  }

  build() {
    Stack() {
      // èƒŒæ™¯
      Column()
        .width('100%')
        .height('100%')
        .backgroundColor(this.isDarkMode ? ThemeColors.Dark.Bg : ThemeColors.Light.Bg)

      Column() {
        // é¡¶éƒ¨å¯¼èˆª
        Row() {
           Image($r('app.media.startIcon')) // ä½¿ç”¨ç°æœ‰çš„å›¾æ ‡
             .width(24)
             .height(24)
             .objectFit(ImageFit.Contain)
             .margin({ right: 8 })
             .visibility(Visibility.None) // æš‚æ—¶éšè—
          
          Text('è®¾ç½®')
            .fontSize(StyleConstants.FONT_LG)
            .fontWeight(FontWeight.Bold)
            .fontColor(this.isDarkMode ? ThemeColors.Dark.TextPrimary : ThemeColors.Light.TextPrimary)
            .textAlign(TextAlign.Center)
            .width('100%')
            .margin({ bottom: StyleConstants.SPACE_MD })
        }
        .width('100%')
        .padding({ top: StyleConstants.SPACE_MD })
      
        // è¿”å›æŒ‰é’® (ç»å¯¹å®šä½å®ç°)
        Row() {
           Text('< è¿”å›')
            .fontColor(this.isDarkMode ? ThemeColors.Dark.TextSecondary : ThemeColors.Light.TextSecondary)
            .onClick(() => {
              router.back();
            })
        }
        .position({ x: StyleConstants.SPACE_MD, y: StyleConstants.SPACE_MD })


        Column({ space: StyleConstants.SPACE_MD }) {
          
          // ä¸ªäººæ¡£æ¡ˆ
          GlassCard({ customPadding: StyleConstants.SPACE_MD }) {
            Row() {
              Column() {
                Text('ä¸ªäººæ¡£æ¡ˆ')
                  .fontSize(StyleConstants.FONT_MD)
                  .fontColor(this.isDarkMode ? ThemeColors.Dark.TextPrimary : ThemeColors.Light.TextPrimary)
                Text('MBTI ä¸æ˜Ÿåº§è®¾å®š')
                  .fontSize(StyleConstants.FONT_XS)
                  .fontColor(this.isDarkMode ? ThemeColors.Dark.TextSecondary : ThemeColors.Light.TextSecondary)
                  .margin({ top: 4 })
              }
              .alignItems(HorizontalAlign.Start)

              Text('>')
                .fontColor(this.isDarkMode ? ThemeColors.Dark.TextSecondary : ThemeColors.Light.TextSecondary)
            }
            .width('100%')
            .justifyContent(FlexAlign.SpaceBetween)
            .onClick(() => {
              router.pushUrl({ url: 'pages/ProfileEditPage' });
            })
          }

          // éšç§ä¿æŠ¤ (æ¨¡æ‹Ÿ)
          GlassCard({ customPadding: StyleConstants.SPACE_MD }) {
            Row() {
              Column() {
                Text('éšç§ä¿æŠ¤é”')
                  .fontSize(StyleConstants.FONT_MD)
                  .fontColor(this.isDarkMode ? ThemeColors.Dark.TextPrimary : ThemeColors.Light.TextPrimary)
                Text('å¼€å¯æŒ‡çº¹/é¢å®¹æ ¡éªŒä½“éªŒ')
                  .fontSize(StyleConstants.FONT_XS)
                  .fontColor(this.isDarkMode ? ThemeColors.Dark.TextSecondary : ThemeColors.Light.TextSecondary)
                  .margin({ top: 4 })
              }
              .alignItems(HorizontalAlign.Start)

              Toggle({ type: ToggleType.Switch, isOn: false })
                .selectedColor(this.isDarkMode ? ThemeColors.Dark.Accent : ThemeColors.Light.Accent)
                .onChange((isOn: boolean) => {
                  if (isOn) {
                    promptAction.showDialog({
                      title: 'ç”Ÿç‰©è¯†åˆ«æ ¡éªŒ',
                      message: 'æ­£åœ¨æ¨¡æ‹Ÿç³»ç»Ÿçº§å®‰å…¨éªŒè¯...\n[ ğŸ” éªŒè¯æˆåŠŸ ]',
                      buttons: [{ text: 'ç¡®å®š', color: this.isDarkMode ? ThemeColors.Dark.Accent : ThemeColors.Light.Accent }]
                    });
                  }
                })
            }
            .width('100%')
            .justifyContent(FlexAlign.SpaceBetween)
          }

          // æ•°æ®ç®¡ç†
          GlassCard({ customPadding: StyleConstants.SPACE_MD }) {
            Column({ space: StyleConstants.SPACE_MD }) {
              Text('æ•°æ®å®‰å…¨')
                .fontSize(StyleConstants.FONT_SM)
                .fontColor(this.isDarkMode ? ThemeColors.Dark.TextSecondary : ThemeColors.Light.TextSecondary)
                .width('100%')
              
              Button('å¯¼å‡ºæ•°æ® (JSON)')
                .width('100%')
                .backgroundColor(this.isDarkMode ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.05)')
                .fontColor(this.isDarkMode ? ThemeColors.Dark.TextPrimary : ThemeColors.Light.TextPrimary)
                .onClick(() => {
                  this.handleExport();
                })

              Button('å¯¼å…¥æ•°æ®')
                .width('100%')
                .backgroundColor(this.isDarkMode ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.05)')
                .fontColor(this.isDarkMode ? ThemeColors.Dark.TextSecondary : ThemeColors.Light.TextSecondary) // å¼±åŒ–æ˜¾ç¤º
                .onClick(() => {
                  this.handleImport();
                })
            }
          }

          // å…³äº
          GlassCard({ customPadding: StyleConstants.SPACE_MD }) {
             Column() {
               Text('HeartStars Journal')
                 .fontSize(StyleConstants.FONT_MD)
                 .fontWeight(FontWeight.Bold)
                 .fontColor(this.isDarkMode ? ThemeColors.Dark.TextPrimary : ThemeColors.Light.TextPrimary)
               Text('v1.0.0')
                 .fontSize(StyleConstants.FONT_SM)
                 .fontColor(this.isDarkMode ? ThemeColors.Dark.TextSecondary : ThemeColors.Light.TextSecondary)
                 .margin({ top: 4 })
             }
             .width('100%')
             .alignItems(HorizontalAlign.Center)
          }

        }
        .padding(StyleConstants.SPACE_MD)
        .margin({ top: 32 })
      }
    }
  }
}
